<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Booking System</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            background-color: #2c3e50;
            color: white;
            border-radius: 8px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .config-section {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .config-section label {
            font-weight: 600;
            min-width: 120px;
        }
        
        .config-section input {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex-grow: 1;
        }
        
        .api-url {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .section-title h2 {
            color: #2c3e50;
        }
        
        .user-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            background-color: #e8f4fc;
            color: #2c3e50;
        }
        
        .user-status.logged-in {
            background-color: #e6ffe6;
            color: #2e7d32;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .card-details {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 10px;
        }
        
        .free-seats {
            font-weight: bold;
            color: #2e7d32;
            margin-top: 10px;
        }
        
        .btn {
            display: inline-block;
            padding: 8px 15px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background-color: #1a252f;
        }
        
        .btn-secondary {
            background-color: #3498db;
        }
        
        .btn-secondary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #27ae60;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .hidden {
            display: none;
        }
        
        .message {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .message-success {
            background-color: #e6ffe6;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .message-error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .observer-options {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Travel booking system</h1>
            <p>Buy some tickets</p>
        </header>
        

            <div class="section" id="navigation-section">
                <div class="section-title">
                    <h2>Explore More Services</h2>
                </div>
                <div style=" display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-top: 15px;">
                    <a href="car-rental.html" class="btn btn-secondary" style="background-color: #2c3e50 !important; flex: 1; max-width: 200px; text-align: center; text-decoration: none;">Car Rental</a>
                    <a href="hotel-rental.html" class="btn btn-success" style="background-color: #2c3e50 !important; flex: 1; max-width: 200px; text-align: center; text-decoration: none;">Hotel Booking</a>
                </div>
            </div>


        <br>
        <div class="config-section">
            <label for="api-base-url">API Base URL:</label>
            <input type="text" id="api-base-url" value="https://localhost:7169" placeholder="https://your-api-url.com">
            <span class="api-url" id="current-api-url">Current: https://localhost:7169</span>
        </div>
        
        <!-- User Registration Section -->
        <div class="section" id="user-section">
            <div class="section-title">
                <h2>User Registration</h2>
                <span class="user-status" id="user-status">Not logged in</span>
            </div>
            <div id="user-registration-form">
                <div class="form-group">
                    <label for="first-name">First Name</label>
                    <input type="text" id="first-name" placeholder="John">
                </div>
                <div class="form-group">
                    <label for="last-name">Last Name</label>
                    <input type="text" id="last-name" placeholder="Doe">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="john.doe@example.com">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="••••••••">
                </div>
                <div class="form-actions">
                    <button class="btn btn-success" id="register-btn">Register</button>
                </div>
            </div>
        </div>
        
        <!-- Flights Section -->
        <div class="section" id="flights-section">
            <div class="section-title">
                <h2>Available Flights</h2>
                <button class="btn" id="load-flights-btn">Refresh Flights</button>
            </div>
            <div id="flights-container" class="grid">
                <!-- Flights will be loaded here -->
                <div class="card">
                    <div class="card-title">Loading flights...</div>
                </div>
            </div>
        </div>
        
        <!-- Planes Section -->
        <div class="section" id="planes-section">
            <div class="section-title">
                <h2>Aircraft</h2>
                <button class="btn" id="load-planes-btn">Refresh Planes</button>
            </div>
            <div id="planes-container" class="grid">
                <!-- Planes will be loaded here -->
                <div class="card">
                    <div class="card-title">Loading planes...</div>
                </div>
            </div>
        </div>
        
        <!-- Booking Section -->
        <div class="section" id="booking-section">
            <div class="section-title">
                <h2>Book a Flight</h2>
            </div>
            <div class="form-group">
                <label for="flight-id">Select Flight</label>
                <select id="flight-id" disabled>
                    <option value="">-- Select a flight --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="booking-amount">Payment Amount</label>
                <input type="number" id="booking-amount" min="0" step="0.01" placeholder="Enter payment amount">
            </div>
            <div class="form-actions">
                <button class="btn" id="book-btn" disabled>Book Flight</button>
            </div>
            <div id="booking-result"></div>
        </div>
        
        <!-- Observer Subscription Section -->
        <div class="section" id="observer-section">
            <div class="section-title">
                <h2>Price Drop Notification</h2>
            </div>
            <p>Subscribe to be notified when flight prices drop:</p>
            <div class="observer-options">
                <div class="option">
                    <input type="radio" id="console-observer" name="observer-type" value="0" checked>
                    <label for="console-observer">Console Observer</label>
                </div>
                <div class="option">
                    <input type="radio" id="file-observer" name="observer-type" value="1">
                    <label for="file-observer">File Observer</label>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn" id="subscribe-btn">Subscribe</button>
            </div>
            <div id="subscription-result"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            const apiBaseUrlInput = document.getElementById('api-base-url');
            const currentApiUrlElement = document.getElementById('current-api-url');
            let API_BASE_URL = 'https://localhost:7246';

            let currentUserId = null;

            if (localStorage.getItem('apiBaseUrl')) {
                API_BASE_URL = localStorage.getItem('apiBaseUrl');
                apiBaseUrlInput.value = API_BASE_URL;
                currentApiUrlElement.textContent = `Current: ${API_BASE_URL}`;
            }
            

            apiBaseUrlInput.addEventListener('change', function() {
                API_BASE_URL = apiBaseUrlInput.value.trim();
                localStorage.setItem('apiBaseUrl', API_BASE_URL);
                currentApiUrlElement.textContent = `Current: ${API_BASE_URL}`;
                alert(`API base URL updated to: ${API_BASE_URL}`);
            });
            
            function checkUserStatus() {
                currentUserId = localStorage.getItem('userId');
                const userStatus = document.getElementById('user-status');
                
                if (currentUserId) {
                    userStatus.textContent = `Logged in (ID: ${currentUserId.substring(0, 8)}...)`;
                    userStatus.classList.add('logged-in');
                    document.getElementById('book-btn').disabled = false;
                    document.getElementById('flight-id').disabled = false;
                } else {
                    userStatus.textContent = 'Not logged in';
                    userStatus.classList.remove('logged-in');
                    document.getElementById('book-btn').disabled = true;
                    document.getElementById('flight-id').disabled = true;
                }
            }
            
            // Register user
            document.getElementById('register-btn').addEventListener('click', async function() {
                const firstName = document.getElementById('first-name').value;
                const lastName = document.getElementById('last-name').value;
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                if (!firstName || !lastName || !email || !password) {
                    showMessage('Please fill in all required fields', 'error');
                    return;
                }
                
                const userData = {
                    firstName,
                    lastName,
                    email,
                    password
                };
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/User/user`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    });
                    
                    if (response.ok) {
                        
                         const userId = await response.text(); // если JSON: const { id } = await response.json();
                        localStorage.setItem('userId', userId);
                        console.log(userId);
                        showMessage('User registered successfully!', 'success');
                        checkUserStatus();
                        
                        // Clear form
                        document.getElementById('first-name').value = '';
                        document.getElementById('last-name').value = '';
                        document.getElementById('email').value = '';
                        document.getElementById('password').value = '';
                    } else {
                        const errorData = await response.json();
                        showMessage(`Registration failed: ${errorData.message || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    showMessage(`Network error: ${error.message}`, 'error');
                }
            });
            
            document.getElementById('load-flights-btn').addEventListener('click', loadFlights);
            loadFlights();

            async function loadFlights() {
                const flightsContainer = document.getElementById('flights-container');
                flightsContainer.innerHTML = '<div class="card"><div class="card-title">Loading flights...</div></div>';

                try {
                const response = await fetch(`${API_BASE_URL}/api/Flight/flights`);
                if (!response.ok) {
                    console.error('Failed to load flights, status:', response.status);
                    flightsContainer.innerHTML = `<div class="card"><div class="card-title">Error loading flights</div><div class="card-details">Status: ${response.status}</div></div>`;
                    return;
                }

                const flights = await response.json();

                if (!Array.isArray(flights) || flights.length === 0) {
                    flightsContainer.innerHTML = '<div class="card"><div class="card-title">No flights available</div></div>';
                    return;
                }

                flightsContainer.innerHTML = '';

                flights.forEach(flight => {
                    console.log('flight object:', flight);
                    const flightId = flight.id;

                    const flightCard = document.createElement('div');
                    flightCard.className = 'card';

                    // безопасно читаем поля (учитываем возможные опечатки)
                    const from = flight.from ?? 'Unknown';
                    const to = flight.to ?? 'Unknown';
                    const price = (typeof flight.price === 'number') ? flight.price : Number(flight.price) || 0;
                    const booked = flight.bookedSeats ?? flight.bookedSeates ?? 0;

                    const departure = flight.departureTime ? new Date(flight.departureTime).toLocaleString() : '—';
                    const arrival = flight.arrivalTime ? new Date(flight.arrivalTime).toLocaleString() : '—';

                    flightCard.innerHTML = `
                    <div class="card-title">${from} → ${to}</div>
                    <div class="card-details">
                        <strong>Departure:</strong> ${departure}<br>
                        <strong>Arrival:</strong> ${arrival}<br>
                        <strong>Price:</strong> $${price.toFixed(2)}<br>
                        <strong>Booked Seats:</strong> ${booked}
                    </div>
                    <div class="free-seats" id="seats-${flightId}">Checking free seats...</div>
                    <button class="btn check-seats-btn" data-id="${flightId}">Check Free Seats</button>
                    `;

                    flightsContainer.appendChild(flightCard);

                    // событие по кнопке
                    flightCard.querySelector('.check-seats-btn').addEventListener('click', function() {
                    const id = this.dataset.id;
                    checkFreeSeats(id);
                    });

                    // проверяем свободные места при загрузке
                    checkFreeSeats(flightId);
                });

                // обновляем дропдаун/прочее если нужно
                updateFlightDropdown?.(flights);

                } catch (error) {
                console.error('Network or parsing error:', error);
                flightsContainer.innerHTML = `<div class="card"><div class="card-title">Network Error</div><div class="card-details">${error.message}</div></div>`;
                }
            }

            async function checkFreeSeats(flightId) {
                const el = document.getElementById(`seats-${flightId}`);
                if (!el) {
                console.warn('seats element not found for', flightId);
                return;
                }

                try {
                console.log('Checking free seats for id:', flightId);
                const url = `${API_BASE_URL}/api/Flight/freeSeats?Id=${encodeURIComponent(flightId)}`;
                const response = await fetch(url);
                const text = await response.text(); // всегда читаем тело для диагностики
                console.log('freeSeats response:', response.status, text);

                if (!response.ok) {
                if (response.status === 404) el.textContent = 'Flight not found (404)';
                else if (response.status === 400) el.textContent = 'Bad request (400)';
                else el.textContent = `Error checking seats (${response.status})`;
                el.style.color = '#c62828';
                return;
                }

                const freeSeats = Number(text);
                el.textContent = `Free Seats: ${Number.isNaN(freeSeats) ? text : freeSeats}`;
                el.style.color = '';
                } catch (error) {
                console.error('Network error when checking seats:', error);
                el.textContent = 'Network error';
                el.style.color = '#c62828';
                }
            }
            
            // Load planes
            document.getElementById('load-planes-btn').addEventListener('click', loadPlanes);
            loadPlanes();
            
            async function loadPlanes() {
                const planesContainer = document.getElementById('planes-container');
                planesContainer.innerHTML = '<div class="card"><div class="card-title">Loading planes...</div></div>';
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/Flight/planes`);
                    
                    if (response.ok) {
                        const planes = await response.json();
                        
                        if (planes.length === 0) {
                            planesContainer.innerHTML = '<div class="card"><div class="card-title">No planes available</div></div>';
                            return;
                        }
                        
                        planesContainer.innerHTML = '';
                        
                        planes.forEach(plane => {
                            const planeCard = document.createElement('div');
                            planeCard.className = 'card';
                            
                            planeCard.innerHTML = `
                                <div class="card-title">${plane.model || 'Unknown Model'}</div>
                                <div class="card-details">
                                    <strong>Seats:</strong> ${plane.seats}
                                </div>
                            `;
                            
                            planesContainer.appendChild(planeCard);
                        });
                    } else {
                        planesContainer.innerHTML = `<div class="card"><div class="card-title">Error loading planes</div><div class="card-details">Status: ${response.status}</div></div>`;
                    }
                } catch (error) {
                    planesContainer.innerHTML = `<div class="card"><div class="card-title">Network Error</div><div class="card-details">${error.message}</div></div>`;
                }
            }
            
            // Update flight dropdown for booking
            function updateFlightDropdown(flights) {
                const flightSelect = document.getElementById('flight-id');
                flightSelect.innerHTML = '<option value="">-- Select a flight --</option>';
                
                flights.forEach(flight => {
                    const option = document.createElement('option');
                    option.value = flight.id;
                    option.textContent = `${flight.from} → ${flight.to} - $${flight.price.toFixed(2)}`;
                    flightSelect.appendChild(option);
                });
            }
            
            // Book flight
           document.getElementById('book-btn').addEventListener('click', async function() {
  const rawFlightId = document.getElementById('flight-id').value?.trim();
  const rawAmount = document.getElementById('booking-amount').value?.trim();
  let currentUserId = (localStorage.getItem('userId') || '').trim();
  currentUserId = currentUserId.replace(/^["']|["']$/g, '').trim();          
  console.log(currentUserId);
  const guidRegex = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;

  if (!rawFlightId || !guidRegex.test(rawFlightId)) {
    console.log(currentUserId);
    showMessage('Please select a valid flight (invalid id)', 'error');
    return;
  }

  if (!currentUserId || !guidRegex.test(currentUserId)) {
    showMessage('Please register / login first (invalid user id)', 'error');
    return;
  }

  if (!rawAmount) {
    showMessage('Please enter a payment amount', 'error');
    return;
  }

  // Санитизируем amount: заменяем запятую на точку, убираем лишние символы (тысячи, валюты)
  const cleaned = rawAmount.replace(',', '.').replace(/[^0-9.\-]/g, '');
  const amount = Number(cleaned);

  if (!Number.isFinite(amount) || amount <= 0) {
    showMessage('Please enter a valid payment amount (e.g. 12.50)', 'error');
    return;
  }

  const bookingData = {
    Id: rawFlightId,
    UserId: currentUserId,
    Price: amount // число — сериализуется в JSON как число
  };

  console.log('Booking payload:', bookingData);

  try {
    const response = await fetch(`${API_BASE_URL}/api/Flight/book`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(bookingData)
    });

    // Для диагностики — читаем тело ответа в любом случае
    const text = await response.text();
    let result = null;
    try { result = JSON.parse(text); } catch { result = text; }

    console.log('Booking response status:', response.status, result);

    if (response.ok) {
      // если API возвращает { success: true, message: "...", ... }
      if (result && result.success === false) {
        showMessage(result.message || 'Booking failed', 'error');
      } else {
        showMessage(result?.message || 'Booking successful!', 'success');
        document.getElementById('booking-amount').value = '';
      }
    } else {
      // покажем детально, что пришло — это ускорит дебаг на сервере
      if (response.status === 400) {
        // возможно ModelState errors
        console.error('BadRequest body:', result);
        showMessage(result?.title || 'Bad Request — check console for details', 'error');
      } else if (response.status === 404) {
        showMessage('Flight or User not found (404)', 'error');
      } else {
        showMessage(`Server error (${response.status}) — check console`, 'error');
      }
    }
  } catch (error) {
    console.error('Network error booking:', error);
    showMessage(`Network error: ${error.message}`, 'error');
  }
});

            
            // Subscribe to observer
            document.getElementById('subscribe-btn').addEventListener('click', async function() {
                const observerType = document.querySelector('input[name="observer-type"]:checked').value;
                const subscriptionResult = document.getElementById('subscription-result');
                
                subscriptionResult.innerHTML = '';
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/Observer/subscribe?number=${observerType}`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        messageDiv.className += ' message-success';
                        messageDiv.textContent = 'Subscription successful! Check console/file for notifications.';
                    } else {
                        messageDiv.className += ' message-error';
                        messageDiv.textContent = `Subscription failed (Status: ${response.status})`;
                    }
                } catch (error) {
                    messageDiv.className += ' message-error';
                    messageDiv.textContent = `Network error: ${error.message}`;
                }
                
                subscriptionResult.appendChild(messageDiv);
            });
            
            // Initialize user status
            checkUserStatus();
            
            // Helper function to show messages
            function showMessage(text, type) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message message-${type}`;
                messageDiv.textContent = text;
                
                // Remove existing messages
                const existingMessages = document.querySelectorAll('.message');
                existingMessages.forEach(msg => msg.remove());
                
                // Add to appropriate section
                if (type === 'error') {
                    // Add to booking section if it's a booking-related error
                    const bookingSection = document.getElementById('booking-result');
                    if (bookingSection) {
                        bookingSection.appendChild(messageDiv);
                    }
                } else {
                    // Add to observer section for success
                    const observerSection = document.getElementById('subscription-result');
                    if (observerSection) {
                        observerSection.appendChild(messageDiv);
                    }
                }
                
                // Auto-remove message after 5 seconds
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 5000);
            }
        });
    </script>
</body>
</html>